{% extends 'base.html' %}

{% block title %}Punto de Venta - {{ app_name }}{% endblock %}

{% block content %}
<div class="pos-container" x-data="posApp()">
    <!-- Left Panel - Products and Cart -->
    <div class="pos-left">
        <!-- Header with Search -->
        <div class="pos-header">
            <h5 class="mb-0">Punto de Venta</h5>
            <div class="pos-search search-bar" style="width: 400px;">
                <span class="material-symbols-rounded">search</span>
                <input type="text"
                       class="form-control"
                       placeholder="Buscar producto por código o nombre... (F2)"
                       x-model="searchQuery"
                       @input.debounce.300ms="searchProducts()"
                       @keydown.enter="addFirstResult()"
                       @keydown.escape="clearSearch()">

                <!-- Search Results Dropdown -->
                <div class="search-results position-absolute bg-white shadow-lg rounded-2 mt-1 w-100"
                     x-show="searchResults.length > 0"
                     x-cloak
                     style="z-index: 1000; max-height: 300px; overflow-y: auto;">
                    <template x-for="product in searchResults" :key="product.id">
                        <div class="search-result-item p-3 border-bottom cursor-pointer"
                             @click="addToCart(product)"
                             style="cursor: pointer;"
                             :class="{'bg-light': product.stock_actual <= 0}">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <span class="badge badge-secondary me-2" x-text="product.codigo"></span>
                                    <span x-text="product.nombre"></span>
                                </div>
                                <div class="text-end">
                                    <strong x-text="formatCurrency(product.precio_venta)"></strong>
                                    <small class="text-muted d-block">
                                        Stock: <span x-text="product.stock_actual"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Cart Area -->
        <div class="cart-area">
            <div class="card h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <span>
                        <span class="material-symbols-rounded me-2">shopping_cart</span>
                        Productos en carrito
                    </span>
                    <span class="badge bg-primary" x-text="cart.length + ' items'"></span>
                </div>
                <div class="card-body p-0">
                    <template x-if="cart.length === 0">
                        <div class="cart-empty">
                            <span class="material-symbols-rounded" style="font-size: 64px;">shopping_cart</span>
                            <p class="mt-3">El carrito está vacío</p>
                            <p class="text-muted small">Busca productos para agregarlos</p>
                        </div>
                    </template>

                    <template x-if="cart.length > 0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th style="width: 100px;">Cantidad</th>
                                        <th style="width: 120px;">P. Unit.</th>
                                        <th style="width: 120px;">Subtotal</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(item, index) in cart" :key="item.producto_id">
                                        <tr>
                                            <td>
                                                <span class="table-code" x-text="item.codigo"></span>
                                                <br>
                                                <small x-text="item.nombre"></small>
                                            </td>
                                            <td>
                                                <div class="input-group input-group-sm">
                                                    <button class="btn btn-outline-secondary" @click="decreaseQty(index)">-</button>
                                                    <input type="number"
                                                           class="form-control text-center qty-input"
                                                           x-model.number="item.cantidad"
                                                           @change="updateQty(index)"
                                                           min="0.001"
                                                           step="0.001">
                                                    <button class="btn btn-outline-secondary" @click="increaseQty(index)">+</button>
                                                </div>
                                            </td>
                                            <td x-text="formatCurrency(item.precio_unitario)"></td>
                                            <td class="fw-bold" x-text="formatCurrency(item.cantidad * item.precio_unitario)"></td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-danger" @click="removeFromCart(index)">
                                                    <span class="material-symbols-rounded">delete</span>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Panel - Payment -->
    <div class="pos-right">
        <div class="payment-section">
            <h5 class="payment-title">Resumen de Venta</h5>

            <!-- Cliente -->
            <div>
                <label class="form-label small text-muted">Cliente</label>
                <select class="form-select" x-model="clienteId">
                    <option value="">Consumidor Final</option>
                    {% for cliente in clientes %}
                    <option value="{{ cliente.id }}">{{ cliente.nombre }} ({{ cliente.dni_cuit or 'S/D' }})</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Totales -->
            <div class="bg-light rounded p-3">
                <div class="summary-row mb-2">
                    <span class="text-muted">Subtotal</span>
                    <span x-text="formatCurrency(subtotal)"></span>
                </div>
                <div class="summary-row mb-2">
                    <span class="text-muted">Descuento</span>
                    <div class="input-group input-group-sm" style="width: 100px;">
                        <input type="number" class="form-control text-end"
                               x-model.number="descuentoPorcentaje"
                               min="0" max="100" step="0.5">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                <hr>
                <div class="summary-row mb-1">
                    <span class="text-muted small">Neto (sin IVA)</span>
                    <span class="small" x-text="formatCurrency(netoSinIva)"></span>
                </div>
                <div class="summary-row mb-2">
                    <span class="text-muted small">IVA (<span x-text="ivaPorcentaje"></span>%)</span>
                    <span class="small" x-text="formatCurrency(ivaMonto)"></span>
                </div>
                <div class="summary-row">
                    <span class="fw-bold">TOTAL</span>
                    <span class="summary-total" x-text="formatCurrency(totalConIva)"></span>
                </div>
                <div class="text-muted small mt-1" style="font-size: 0.75em;">
                    {% if precios_con_iva %}Los precios incluyen IVA{% else %}Los precios no incluyen IVA{% endif %}
                </div>
            </div>

            <!-- Forma de Pago -->
            <div>
                <label class="form-label small text-muted">Forma de pago</label>
                <div class="payment-methods">
                    <div class="payment-method"
                         :class="{'active': formaPago === 'efectivo'}"
                         @click="formaPago = 'efectivo'">
                        <span class="material-symbols-rounded d-block mb-1">payments</span>
                        <small>Efectivo</small>
                    </div>
                    <div class="payment-method"
                         :class="{'active': formaPago === 'tarjeta_debito'}"
                         @click="formaPago = 'tarjeta_debito'">
                        <span class="material-symbols-rounded d-block mb-1">credit_card</span>
                        <small>Débito</small>
                    </div>
                    <div class="payment-method"
                         :class="{'active': formaPago === 'tarjeta_credito'}"
                         @click="formaPago = 'tarjeta_credito'">
                        <span class="material-symbols-rounded d-block mb-1">credit_score</span>
                        <small>Crédito</small>
                    </div>
                    <div class="payment-method"
                         :class="{'active': formaPago === 'transferencia'}"
                         @click="formaPago = 'transferencia'">
                        <span class="material-symbols-rounded d-block mb-1">account_balance</span>
                        <small>Transfer.</small>
                    </div>
                    <div class="payment-method"
                         :class="{'active': formaPago === 'cuenta_corriente'}"
                         @click="formaPago = 'cuenta_corriente'"
                         :disabled="!clienteId">
                        <span class="material-symbols-rounded d-block mb-1">account_balance_wallet</span>
                        <small>Cta. Cte.</small>
                    </div>
                </div>
            </div>

            <!-- Cálculo de vuelto (solo efectivo) -->
            <div x-show="formaPago === 'efectivo'" x-cloak>
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label small text-muted">Monto recibido</label>
                        <input type="number" class="form-control"
                               x-model.number="montoRecibido"
                               placeholder="$0.00"
                               step="0.01">
                    </div>
                    <div class="col-6">
                        <label class="form-label small text-muted">Vuelto</label>
                        <input type="text" class="form-control bg-light"
                               :value="formatCurrency(vuelto)"
                               readonly>
                    </div>
                </div>
            </div>

            <!-- Spacer -->
            <div class="flex-grow-1"></div>

            <!-- Botones de acción -->
            <div class="d-grid gap-2">
                <button class="btn btn-primary btn-confirm-sale"
                        @click="confirmarVenta()"
                        :disabled="cart.length === 0 || processing">
                    <span class="material-symbols-rounded me-2">check_circle</span>
                    <span x-text="processing ? 'Procesando...' : 'Confirmar Venta (F12)'"></span>
                </button>
                <button class="btn btn-outline-secondary"
                        @click="limpiarCarrito()"
                        :disabled="cart.length === 0">
                    <span class="material-symbols-rounded me-2">delete_sweep</span>
                    Limpiar (F4)
                </button>
            </div>
        </div>
    </div>

    <!-- Form oculto para enviar la venta -->
    <form id="ventaForm" method="POST" action="{{ url_for('ventas.punto_de_venta') }}" style="display: none;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="cliente_id" x-model="clienteId">
        <input type="hidden" name="forma_pago" x-model="formaPago">
        <input type="hidden" name="descuento_porcentaje" x-model="descuentoPorcentaje">
        <input type="hidden" name="items_json" :value="JSON.stringify(cart)">
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
function posApp() {
    return {
        searchQuery: '',
        searchResults: [],
        cart: [],
        clienteId: '',
        formaPago: 'efectivo',
        descuentoPorcentaje: 0,
        montoRecibido: 0,
        processing: false,

        get subtotal() {
            return this.cart.reduce((sum, item) => sum + (item.cantidad * item.precio_unitario), 0);
        },

        get descuentoMonto() {
            return this.subtotal * (this.descuentoPorcentaje / 100);
        },

        get total() {
            return this.subtotal - this.descuentoMonto;
        },

        get ivaPorcentaje() { return {{ iva_porcentaje|default(21) }}; },
        get preciosConIva() { return {{ 'true' if precios_con_iva else 'false' }}; },
        get netoSinIva() {
            if (this.preciosConIva) return this.total / (1 + this.ivaPorcentaje / 100);
            return this.total;
        },
        get ivaMonto() {
            if (this.preciosConIva) return this.total - this.netoSinIva;
            return this.total * this.ivaPorcentaje / 100;
        },
        get totalConIva() {
            if (this.preciosConIva) return this.total;
            return this.total + this.ivaMonto;
        },

        get vuelto() {
            return Math.max(0, this.montoRecibido - this.totalConIva);
        },

        formatCurrency(value) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS'
            }).format(value || 0);
        },

        async searchProducts() {
            if (this.searchQuery.length < 2) {
                this.searchResults = [];
                return;
            }

            try {
                const response = await fetch(`{{ url_for('productos.buscar') }}?q=${encodeURIComponent(this.searchQuery)}`);
                this.searchResults = await response.json();
            } catch (error) {
                console.error('Error searching products:', error);
            }
        },

        addFirstResult() {
            if (this.searchResults.length > 0) {
                this.addToCart(this.searchResults[0]);
            }
        },

        addToCart(product) {
            // Verificar stock
            if (product.stock_actual <= 0) {
                showAlert('Este producto no tiene stock disponible.');
                return;
            }

            // Buscar si ya está en el carrito
            const existingIndex = this.cart.findIndex(item => item.producto_id === product.id);

            if (existingIndex >= 0) {
                // Verificar que no exceda el stock
                if (this.cart[existingIndex].cantidad + 1 > product.stock_actual) {
                    showAlert('No hay suficiente stock disponible.');
                    return;
                }
                this.cart[existingIndex].cantidad += 1;
            } else {
                this.cart.push({
                    producto_id: product.id,
                    codigo: product.codigo,
                    nombre: product.nombre,
                    cantidad: 1,
                    precio_unitario: product.precio_venta,
                    stock_disponible: product.stock_actual
                });
            }

            this.clearSearch();
        },

        removeFromCart(index) {
            this.cart.splice(index, 1);
        },

        increaseQty(index) {
            const item = this.cart[index];
            if (item.cantidad + 1 <= item.stock_disponible) {
                item.cantidad += 1;
            }
        },

        decreaseQty(index) {
            const item = this.cart[index];
            if (item.cantidad > 1) {
                item.cantidad -= 1;
            } else {
                this.removeFromCart(index);
            }
        },

        updateQty(index) {
            const item = this.cart[index];
            if (item.cantidad <= 0) {
                this.removeFromCart(index);
            } else if (item.cantidad > item.stock_disponible) {
                item.cantidad = item.stock_disponible;
                showAlert('Cantidad ajustada al stock disponible.');
            }
        },

        clearSearch() {
            this.searchQuery = '';
            this.searchResults = [];
        },

        async limpiarCarrito() {
            const ok = await showConfirm('¿Estás seguro de limpiar el carrito?', {
                title: 'Limpiar carrito',
                confirmText: 'Limpiar',
                confirmClass: 'btn-danger',
                icon: 'remove_shopping_cart',
                iconColor: 'var(--error)'
            });
            if (ok) {
                this.cart = [];
                this.descuentoPorcentaje = 0;
                this.montoRecibido = 0;
                this.clienteId = '';
            }
        },

        async confirmarVenta() {
            if (this.cart.length === 0) {
                showAlert('El carrito está vacío.');
                return;
            }

            if (this.formaPago === 'cuenta_corriente' && !this.clienteId) {
                showAlert('Debes seleccionar un cliente para pagar a cuenta corriente.');
                return;
            }

            if (this.formaPago === 'efectivo' && this.montoRecibido < this.total) {
                const ok = await showConfirm('El monto recibido es menor al total. ¿Deseas continuar?', {
                    title: 'Monto insuficiente',
                    confirmText: 'Continuar',
                    confirmClass: 'btn-warning',
                    icon: 'payments',
                    iconColor: 'var(--warning)'
                });
                if (!ok) return;
            }

            this.processing = true;
            document.getElementById('ventaForm').submit();
        },

        init() {
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F2') {
                    e.preventDefault();
                    document.querySelector('.pos-search input').focus();
                }
                if (e.key === 'F4') {
                    e.preventDefault();
                    this.limpiarCarrito();
                }
                if (e.key === 'F12') {
                    e.preventDefault();
                    this.confirmarVenta();
                }
            });
        }
    }
}
</script>

<style>
[x-cloak] { display: none !important; }
</style>
{% endblock %}
