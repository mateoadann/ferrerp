{% extends 'base.html' %}

{% block title %}{% if editando %}Editar{% else %}Nuevo{% endif %} Presupuesto - {{ app_name }}{% endblock %}

{% block content %}
<div class="pos-container" x-data="presupuestoApp()" x-init="init()">
    <!-- Panel izquierdo: Búsqueda y productos -->
    <div class="pos-left">
        <div class="pos-header">
            <h5 class="mb-0">{% if editando %}Editar Presupuesto #{{ presupuesto.numero_completo }}{% else %}Nuevo Presupuesto{% endif %}</h5>
            <div class="pos-search search-bar" style="width: 400px;">
                <span class="material-symbols-rounded">search</span>
                <input type="text"
                       class="form-control"
                       placeholder="Buscar producto por código o nombre..."
                       x-model="searchQuery"
                       @input.debounce.300ms="searchProducts()"
                       @keydown.enter="addFirstResult()"
                       @keydown.escape="clearSearch()">

                <div class="search-results position-absolute bg-white shadow-lg rounded-2 mt-1 w-100"
                     x-show="searchResults.length > 0"
                     x-cloak
                     style="z-index: 1000; max-height: 300px; overflow-y: auto;">
                    <template x-for="product in searchResults" :key="product.id">
                        <div class="search-result-item p-3 border-bottom cursor-pointer"
                             @click="addToCart(product)"
                             style="cursor: pointer;">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <span class="badge badge-secondary me-2" x-text="product.codigo"></span>
                                    <span x-text="product.nombre"></span>
                                </div>
                                <div class="text-end">
                                    <strong x-text="formatCurrency(product.precio_venta)"></strong>
                                    <small class="text-muted d-block">
                                        Stock: <span x-text="product.stock_actual"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Carrito -->
        <div class="cart-area">
            <div class="card h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <span>
                        <span class="material-symbols-rounded me-2">description</span>
                        Productos del presupuesto
                    </span>
                    <span class="badge bg-primary" x-text="cart.length + ' items'"></span>
                </div>
                <div class="card-body p-0">
                    <template x-if="cart.length === 0">
                        <div class="cart-empty">
                            <span class="material-symbols-rounded" style="font-size: 64px;">description</span>
                            <p class="mt-3">Sin productos</p>
                            <p class="text-muted small">Busca productos para agregarlos al presupuesto</p>
                        </div>
                    </template>

                    <template x-if="cart.length > 0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th style="width: 100px;">Cantidad</th>
                                        <th style="width: 120px;">P. Unit.</th>
                                        <th style="width: 120px;">Subtotal</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(item, index) in cart" :key="item.producto_id">
                                        <tr>
                                            <td>
                                                <span class="table-code" x-text="item.codigo"></span>
                                                <br>
                                                <small x-text="item.nombre"></small>
                                            </td>
                                            <td>
                                                <div class="input-group input-group-sm">
                                                    <button class="btn btn-outline-secondary" @click="decreaseQty(index)">-</button>
                                                    <input type="number"
                                                           class="form-control text-center qty-input"
                                                           x-model.number="item.cantidad"
                                                           @change="updateQty(index)"
                                                           min="0.001"
                                                           step="0.001">
                                                    <button class="btn btn-outline-secondary" @click="increaseQty(index)">+</button>
                                                </div>
                                            </td>
                                            <td>
                                                <input type="text"
                                                       class="form-control form-control-sm text-end"
                                                       x-model="item.precio_unitario_display"
                                                       data-mask="money"
                                                       inputmode="decimal"
                                                       x-init="initMoneyInput($el)"
                                                       @input="actualizarPrecio(index, $event)"
                                                       min="0"
                                                       step="0.01">
                                            </td>
                                            <td class="fw-bold" x-text="formatCurrency(item.cantidad * parseMoneyNumber(item.precio_unitario))"></td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-danger" @click="removeFromCart(index)">
                                                    <span class="material-symbols-rounded">delete</span>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel derecho: Datos y totales -->
    <div class="pos-right">
        <div class="payment-section">
            <h5 class="payment-title">Datos del Presupuesto</h5>

            <!-- Tipo de cliente -->
            <div>
                <label class="form-label small text-muted">Tipo de cliente</label>
                <div class="d-flex gap-2 mb-2">
                    <button type="button" class="btn btn-sm"
                            :class="tipoCliente === 'sin' ? 'btn-primary' : 'btn-outline-secondary'"
                            @click="tipoCliente = 'sin'; clienteId = ''">Sin cliente</button>
                    <button type="button" class="btn btn-sm"
                            :class="tipoCliente === 'registrado' ? 'btn-primary' : 'btn-outline-secondary'"
                            @click="tipoCliente = 'registrado'">Registrado</button>
                    <button type="button" class="btn btn-sm"
                            :class="tipoCliente === 'ocasional' ? 'btn-primary' : 'btn-outline-secondary'"
                            @click="tipoCliente = 'ocasional'; clienteId = ''">Ocasional</button>
                </div>

                <!-- Cliente registrado -->
                <div x-show="tipoCliente === 'registrado'" x-cloak>
                    <select class="form-select" x-model="clienteId">
                        <option value="">Seleccionar cliente...</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente.id }}">{{ cliente.nombre }} ({{ cliente.dni_cuit or 'S/D' }})</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Cliente ocasional -->
                <div x-show="tipoCliente === 'ocasional'" x-cloak>
                    <input type="text" class="form-control mb-2" placeholder="Nombre del cliente"
                           x-model="clienteNombre">
                    <input type="text" class="form-control" placeholder="Teléfono (para WhatsApp)"
                           x-model="clienteTelefono">
                </div>
            </div>

            <!-- Validez -->
            <div>
                <label class="form-label small text-muted">Validez</label>
                <div class="input-group">
                    <input type="number" class="form-control" x-model.number="validezDias" min="1" max="365">
                    <span class="input-group-text">días</span>
                </div>
                <small class="text-muted" x-text="'Vence: ' + fechaVencimiento"></small>
            </div>

            <!-- Totales -->
            <div class="bg-light rounded p-3">
                <div class="summary-row mb-2">
                    <span class="text-muted">Subtotal</span>
                    <span x-text="formatCurrency(subtotal)"></span>
                </div>
                <div class="summary-row mb-2">
                    <span class="text-muted">Descuento</span>
                    <div class="input-group input-group-sm" style="width: 100px;">
                        <input type="number" class="form-control text-end"
                               x-model.number="descuentoPorcentaje"
                               min="0" max="100" step="0.5">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                {% if editando is not defined or not editando %}
                <div class="summary-row mb-2" x-show="descuentoPorcentaje > 0">
                    <span class="text-muted">Desc. monto</span>
                    <span class="text-danger" x-text="'-' + formatCurrency(descuentoMonto)"></span>
                </div>
                {% endif %}
                <hr>
                <div class="summary-row mb-1">
                    <span class="text-muted small">Neto (sin IVA)</span>
                    <span class="small" x-text="formatCurrency(netoSinIva)"></span>
                </div>
                <div class="summary-row mb-2">
                    <span class="text-muted small">IVA (<span x-text="ivaPorcentaje"></span>%)</span>
                    <span class="small" x-text="formatCurrency(ivaMonto)"></span>
                </div>
                <div class="summary-row">
                    <span class="fw-bold">TOTAL</span>
                    <span class="summary-total" x-text="formatCurrency(totalConIva)"></span>
                </div>
                <div class="text-muted small mt-1" style="font-size: 0.75em;">
                    {% if precios_con_iva %}Los precios incluyen IVA{% else %}Los precios no incluyen IVA{% endif %}
                </div>
            </div>

            <!-- Notas -->
            <div>
                <label class="form-label small text-muted">Notas / Observaciones</label>
                <textarea class="form-control" rows="3" x-model="notas"
                          placeholder="Observaciones para el cliente..."></textarea>
            </div>

            <div class="flex-grow-1"></div>

            <!-- Botones -->
            <div class="d-grid gap-2">
                <button class="btn btn-primary btn-confirm-sale"
                        @click="guardarPresupuesto()"
                        :disabled="cart.length === 0 || processing">
                    <span class="material-symbols-rounded me-2">save</span>
                    <span x-text="processing ? 'Guardando...' : '{% if editando %}Guardar Cambios{% else %}Guardar Presupuesto{% endif %}'"></span>
                </button>
                <a href="{% if editando %}{{ url_for('presupuestos.detalle', id=presupuesto.id) }}{% else %}{{ url_for('presupuestos.index') }}{% endif %}"
                   class="btn btn-outline-secondary">
                    <span class="material-symbols-rounded me-2">close</span>
                    Cancelar
                </a>
            </div>
        </div>
    </div>

    <!-- Form oculto -->
    <form id="presupuestoForm"
          method="POST"
          action="{% if editando %}{{ url_for('presupuestos.editar', id=presupuesto.id) }}{% else %}{{ url_for('presupuestos.nuevo') }}{% endif %}"
          style="display: none;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="cliente_id" x-model="clienteId">
        <input type="hidden" name="cliente_nombre" x-model="clienteNombre">
        <input type="hidden" name="cliente_telefono" x-model="clienteTelefono">
        <input type="hidden" name="descuento_porcentaje" x-model="descuentoPorcentaje">
        <input type="hidden" name="validez_dias" x-model="validezDias">
        <input type="hidden" name="notas" x-model="notas">
        <input type="hidden" name="items_json" :value="JSON.stringify(cart)">
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
function presupuestoApp() {
    return {
        searchQuery: '',
        searchResults: [],
        cart: {{ items_existentes|default('[]')|safe }},
        tipoCliente: {% if editando and presupuesto.cliente_id %}'registrado'{% elif editando and presupuesto.cliente_nombre %}'ocasional'{% else %}'sin'{% endif %},
        clienteId: '{{ presupuesto.cliente_id if editando and presupuesto.cliente_id else "" }}',
        clienteNombre: '{{ presupuesto.cliente_nombre if editando and presupuesto.cliente_nombre else "" }}',
        clienteTelefono: '{{ presupuesto.cliente_telefono if editando and presupuesto.cliente_telefono else "" }}',
        descuentoPorcentaje: {{ presupuesto.descuento_porcentaje if editando else 0 }},
        validezDias: {{ validez_default|default(15) }},
        notas: '{{ presupuesto.notas|default("")|e if editando else "" }}',
        processing: false,

        get subtotal() {
            return this.cart.reduce(
                (sum, item) => sum + (item.cantidad * parseMoneyNumber(item.precio_unitario)),
                0
            );
        },

        get descuentoMonto() {
            return this.subtotal * (this.descuentoPorcentaje / 100);
        },

        get total() {
            return this.subtotal - this.descuentoMonto;
        },

        get ivaPorcentaje() { return {{ iva_porcentaje|default(21) }}; },
        get preciosConIva() { return {{ 'true' if precios_con_iva else 'false' }}; },
        get netoSinIva() {
            if (this.preciosConIva) return this.total / (1 + this.ivaPorcentaje / 100);
            return this.total;
        },
        get ivaMonto() {
            if (this.preciosConIva) return this.total - this.netoSinIva;
            return this.total * this.ivaPorcentaje / 100;
        },
        get totalConIva() {
            if (this.preciosConIva) return this.total;
            return this.total + this.ivaMonto;
        },

        get fechaVencimiento() {
            const d = new Date();
            d.setDate(d.getDate() + this.validezDias);
            return d.toLocaleDateString('es-AR');
        },

        formatCurrency(value) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS'
            }).format(value || 0);
        },

        async searchProducts() {
            if (this.searchQuery.length < 2) {
                this.searchResults = [];
                return;
            }
            try {
                const response = await fetch(`{{ url_for('productos.buscar') }}?q=${encodeURIComponent(this.searchQuery)}`);
                this.searchResults = await response.json();
            } catch (error) {
                console.error('Error searching products:', error);
            }
        },

        addFirstResult() {
            if (this.searchResults.length > 0) {
                this.addToCart(this.searchResults[0]);
            }
        },

        addToCart(product) {
            const existingIndex = this.cart.findIndex(item => item.producto_id === product.id);

            if (existingIndex >= 0) {
                this.cart[existingIndex].cantidad += 1;
            } else {
                this.cart.push({
                    producto_id: product.id,
                    codigo: product.codigo,
                    nombre: product.nombre,
                    cantidad: 1,
                    precio_unitario: product.precio_venta,
                    precio_unitario_display: formatMoneyOnBlur(String(product.precio_venta || 0)),
                    stock_disponible: product.stock_actual
                });
            }
            this.clearSearch();
        },

        removeFromCart(index) {
            this.cart.splice(index, 1);
        },

        increaseQty(index) {
            this.cart[index].cantidad += 1;
        },

        decreaseQty(index) {
            if (this.cart[index].cantidad > 1) {
                this.cart[index].cantidad -= 1;
            } else {
                this.removeFromCart(index);
            }
        },

        updateQty(index) {
            if (this.cart[index].cantidad <= 0) {
                this.removeFromCart(index);
            }
        },

        actualizarPrecio(index, event) {
            const value = event.target.value;
            this.cart[index].precio_unitario_display = value;
            this.cart[index].precio_unitario = parseMoneyNumber(value);
        },

        clearSearch() {
            this.searchQuery = '';
            this.searchResults = [];
        },

        guardarPresupuesto() {
            if (this.cart.length === 0) {
                showAlert('Agrega al menos un producto al presupuesto.');
                return;
            }
            this.processing = true;
            document.getElementById('presupuestoForm').submit();
        },

        init() {
            this.cart = (this.cart || []).map((item) => ({
                ...item,
                precio_unitario_display: formatMoneyOnBlur(String(item.precio_unitario || 0))
            }));
        }
    }
}
</script>
<style>
[x-cloak] { display: none !important; }
</style>
{% endblock %}
