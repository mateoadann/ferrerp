{% extends 'base.html' %}

{% block title %}Nueva Orden de Compra - {{ app_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.3/air-datepicker.css">
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="{{ url_for('compras.index') }}">Ordenes de Compra</a></li>
                <li class="breadcrumb-item active">Nueva Orden</li>
            </ol>
        </nav>
        <h2>Nueva Orden de Compra</h2>
    </div>
</div>

<form method="POST" x-data="ordenCompraForm()" x-init="init()">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">Datos de la Orden</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Proveedor *</label>
                            <select name="proveedor_id" class="form-select" x-model="proveedorId" @change="proveedorId = $event.target.value; filtrarProductos()" required>
                                <option value="">Seleccionar proveedor...</option>
                                {% for proveedor in proveedores %}
                                <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha</label>
                            <input type="text"
                                   name="fecha"
                                   class="form-control"
                                   placeholder="dd/mm/aaaa"
                                   value="{{ now().strftime('%d/%m/%Y') if now else '' }}"
                                   x-ref="fechaInput">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notas</label>
                            <textarea name="notas" class="form-control" rows="2" placeholder="Notas adicionales..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Productos</span>
                    <button type="button" class="btn btn-sm btn-primary" @click="agregarLinea()">
                        <span class="material-symbols-rounded me-1">add</span>
                        Agregar Producto
                    </button>
                </div>
                <div class="card-body p-0">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th style="width: 120px;">Cantidad</th>
                                <th style="width: 150px;">Precio Unit.</th>
                                <th style="width: 150px;">Subtotal</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(linea, index) in lineas" :key="index">
                                <tr>
                                    <td>
                                        <select :name="'producto_id[]'" class="form-select" x-model="linea.producto_id" @change="actualizarPrecio(index)">
                                            <option value="">Seleccionar...</option>
                                            <template x-for="producto in productosFiltrados" :key="producto.id">
                                                <option :value="producto.id" x-text="`${producto.codigo} - ${producto.nombre}`"></option>
                                            </template>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" :name="'cantidad[]'" class="form-control"
                                               x-model.number="linea.cantidad" @input="calcularSubtotal(index)"
                                               min="0" step="0.001">
                                    </td>
                                    <td>
                                         <input type="text" :name="'precio[]'" class="form-control"
                                               x-model="linea.precio_display" @input="actualizarPrecioInput(index, $event)"
                                               data-mask="money" inputmode="decimal" x-init="initMoneyInput($el)"
                                               min="0" step="0.01">
                                    </td>
                                    <td class="text-end fw-bold" x-text="formatCurrency(linea.subtotal)"></td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-danger" @click="eliminarLinea(index)">
                                            <span class="material-symbols-rounded">delete</span>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td colspan="3" class="text-end fw-bold">TOTAL:</td>
                                <td class="text-end fw-bold" style="font-size: 1.2em;" x-text="formatCurrency(total)"></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Resumen</div>
                <div class="card-body">
                    <dl class="mb-0">
                        <dt class="text-muted">Productos:</dt>
                        <dd x-text="lineas.filter(l => l.producto_id).length + ' items'"></dd>
                        <dt class="text-muted">Total:</dt>
                        <dd class="fs-4 fw-bold text-primary" x-text="formatCurrency(total)"></dd>
                    </dl>
                </div>
                <div class="card-footer">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" :disabled="lineas.filter(l => l.producto_id).length === 0">
                            <span class="material-symbols-rounded me-2">save</span>
                            Crear Orden
                        </button>
                        <a href="{{ url_for('compras.index') }}" class="btn btn-outline-secondary">
                            Cancelar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.3/air-datepicker.js"></script>
<script>
const localeEs = {
    days: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
    daysShort: ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'],
    daysMin: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
    months: [
        'Enero',
        'Febrero',
        'Marzo',
        'Abril',
        'Mayo',
        'Junio',
        'Julio',
        'Agosto',
        'Septiembre',
        'Octubre',
        'Noviembre',
        'Diciembre'
    ],
    monthsShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
    today: 'Hoy',
    clear: 'Limpiar',
    dateFormat: 'dd/MM/yyyy',
    timeFormat: 'hh:mm aa',
    firstDay: 1
};

const productosData = {{ productos_data|tojson }};

function ordenCompraForm() {
    return {
        proveedorId: '',
        productos: productosData,
        lineas: [{ producto_id: '', cantidad: 1, precio: 0, precio_display: '0,00', subtotal: 0 }],

        get total() {
            return this.lineas.reduce((sum, l) => sum + (l.subtotal || 0), 0);
        },

        get productosFiltrados() {
            if (!this.proveedorId) {
                return this.productos;
            }
            const proveedorId = String(this.proveedorId);
            return this.productos.filter(
                (producto) => String(producto.proveedor_id || '') === proveedorId
            );
        },

        agregarLinea() {
            this.lineas.push({ producto_id: '', cantidad: 1, precio: 0, precio_display: '0,00', subtotal: 0 });
            this.$nextTick(() => this.filtrarProductos());
        },

        eliminarLinea(index) {
            if (this.lineas.length > 1) {
                this.lineas.splice(index, 1);
            }
        },

        obtenerProducto(productoId) {
            return this.productos.find(
                (producto) => String(producto.id) === String(productoId)
            );
        },

        formatFecha(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        },

        parseFecha(value) {
            const parts = String(value || '').split('/');
            if (parts.length !== 3) {
                return null;
            }
            const day = Number.parseInt(parts[0], 10);
            const month = Number.parseInt(parts[1], 10) - 1;
            const year = Number.parseInt(parts[2], 10);
            if (Number.isNaN(day) || Number.isNaN(month) || Number.isNaN(year)) {
                return null;
            }
            return new Date(year, month, day);
        },

        initDatepicker() {
            const input = this.$refs.fechaInput;
            if (!input || typeof AirDatepicker === 'undefined') {
                return;
            }

            const initialDate = this.parseFecha(input.value) || new Date();
            if (!input.value) {
                input.value = this.formatFecha(initialDate);
            }

            new AirDatepicker(input, {
                autoClose: true,
                locale: localeEs,
                dateFormat: 'dd/MM/yyyy',
                selectedDates: [initialDate]
            });
        },

        actualizarPrecio(index) {
            const linea = this.lineas[index];
            const producto = this.obtenerProducto(linea.producto_id);
            if (producto) {
                linea.precio = producto.precio_costo || 0;
                linea.precio_display = formatMoneyOnBlur(String(linea.precio || 0));
                this.calcularSubtotal(index);
                return;
            }
            linea.precio = 0;
            linea.precio_display = '0,00';
            this.calcularSubtotal(index);
        },

        filtrarProductos() {
            if (!this.proveedorId) {
                return;
            }
            const proveedorId = String(this.proveedorId);
            this.lineas.forEach((linea) => {
                if (!linea.producto_id) {
                    return;
                }
                const producto = this.obtenerProducto(linea.producto_id);
                const productoProveedor = producto ? String(producto.proveedor_id || '') : '';
                if (!producto || productoProveedor !== proveedorId) {
                    linea.producto_id = '';
                    linea.precio = 0;
                    linea.precio_display = '0,00';
                    linea.subtotal = 0;
                }
            });
        },

        actualizarPrecioInput(index, event) {
            const value = event.target.value;
            const linea = this.lineas[index];
            linea.precio_display = value;
            linea.precio = parseMoneyNumber(value);
            this.calcularSubtotal(index);
        },

        calcularSubtotal(index) {
            const linea = this.lineas[index];
            linea.subtotal = (linea.cantidad || 0) * (linea.precio || 0);
        },

        formatCurrency(value) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS'
            }).format(value || 0);
        },

        init() {
            this.$nextTick(() => {
                this.filtrarProductos();
                this.initDatepicker();
            });
        }
    }
}
</script>
{% endblock %}
